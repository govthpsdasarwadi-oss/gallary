<!DOCTYPE html>
<html lang="kn">
<head>
<meta charset="UTF-8">
<title>Dasarwadi School Gallery - Cloud Powered</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

<style>
    body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; background: #000; color: white; overflow: hidden; }
    header { background: #0a3d62; padding: 15px; text-align: center; font-weight: bold; font-size: 18px; cursor: pointer; border-bottom: 2px solid #3498db; }
    .slider { width: 100vw; height: calc(100vh - 54px); position: relative; overflow: hidden; }
    .slides { display: flex; height: 100%; transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
    .slides img { width: 100vw; height: 100%; object-fit: contain; background: #000; flex-shrink: 0; }

    #admin { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f4f7f6; color: #333; z-index: 1000; padding: 15px; box-sizing: border-box; overflow-y: auto; }
    .admin-card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); max-width: 500px; margin: auto; }
    
    .upload-box { background: #eef2f3; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 2px dashed #0a3d62; text-align: center; }
    button { width: 100%; padding: 14px; margin: 8px 0; border-radius: 10px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; }
    .save-btn { background: #0a3d62; color: white; }
    .close-btn { background: #95a5a6; color: white; }
    
    #thumbs { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px; }
    .thumb-wrapper { position: relative; border-radius: 8px; overflow: hidden; background: #ddd; border: 1px solid #ccc; }
    img.thumb { width: 100%; aspect-ratio: 4/3; object-fit: cover; display: block; }
    .del-btn { background: #e74c3c; color: white; padding: 5px; font-size: 12px; }
    
    #loading-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7); z-index: 2000; justify-content: center; align-items: center; color: white; }
</style>
</head>

<body>

<div id="loading-overlay">Uploading to Cloud...</div>

<header id="title">ಸರಕಾರಿ ಹಿರಿಯ ಪ್ರಾಥಮಿಕ ಶಾಲೆ ದಾಸರವಾಡಿ Gallery</header>

<div class="slider"><div class="slides" id="slides"></div></div>

<div id="admin">
    <div class="admin-card">
        <h3>Admin Settings (Cloud)</h3>
        <div class="upload-box">
            <input type="file" id="file" accept="image/*">
            <button class="save-btn" onclick="uploadToFirebase()">Upload to Cloud</button>
        </div>
        
        <div style="display:flex; justify-content:space-between; font-weight:bold; margin-top:10px;">
            <span>Cloud Photos</span>
            <span id="imgCount">0 Photos</span>
        </div>

        <div id="thumbs"></div>
        <button class="close-btn" onclick="closeAdmin()">Close Panel</button>
    </div>
</div>

<script>
// --- 1. REPLACE THIS BLOCK WITH YOUR FIREBASE CONFIG ---
const firebaseConfig = {
  apiKey: "AIzaSyD_z7J_MrG5yEv_zJYmt_sHpXeeF76doBE",
  authDomain: "gallary-400ef.firebaseapp.com",
  projectId: "gallary-400ef",
  storageBucket: "gallary-400ef.firebasestorage.app",
  messagingSenderId: "136788870871",
  appId: "1:136788870871:web:7c7686952357bd2eabd292"
};



firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

let images = []; // Format: { id: "doc_id", url: "http..." }

// --- Sync with Firebase Realtime ---
db.collection("school_gallery").orderBy("createdAt", "desc").onSnapshot((snapshot) => {
    images = snapshot.docs.map(doc => ({ id: doc.id, url: doc.data().url }));
    renderUI();
});

function renderUI() {
    const slidesDiv = document.getElementById("slides");
    const thumbsDiv = document.getElementById("thumbs");

    // Render Slider
    slidesDiv.innerHTML = images.length === 0 ? 
        "<div style='width:100vw; height:100%; display:flex; align-items:center; justify-content:center;'>No photos in cloud</div>" : 
        images.map(img => `<img src="${img.url}">`).join('');
    
    // Render Admin Thumbs
    thumbsDiv.innerHTML = images.map((img) => `
        <div class="thumb-wrapper">
            <img class="thumb" src="${img.url}">
            <button class="del-btn" onclick="deleteFromFirebase('${img.id}', '${img.url}')">DELETE</button>
        </div>
    `).join('');

    document.getElementById("imgCount").innerText = `${images.length} Photos`;
    startAutoSlide();
}

async function uploadToFirebase() {
    const fileInput = document.getElementById("file");
    const file = fileInput.files[0];
    if (!file) return alert("Select a file first");

    document.getElementById("loading-overlay").style.display = "flex";

    try {
        // 1. Upload file to Firebase Storage
        const fileName = Date.now() + "_" + file.name;
        const storageRef = storage.ref('gallery/' + fileName);
        const snapshot = await storageRef.put(file);
        const downloadURL = await snapshot.ref.getDownloadURL();

        // 2. Save URL to Firestore
        await db.collection("school_gallery").add({
            url: downloadURL,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        fileInput.value = "";
        alert("Uploaded successfully!");
    } catch (e) {
        console.error(e);
        alert("Error uploading: " + e.message);
    } finally {
        document.getElementById("loading-overlay").style.display = "none";
    }
}

async function deleteFromFirebase(id, url) {
    if (!confirm("Delete this photo forever?")) return;
    
    try {
        await db.collection("school_gallery").doc(id).delete();
        // Optional: Also delete from Storage to save space
        const storageRef = storage.refFromURL(url);
        await storageRef.delete();
    } catch (e) {
        alert("Delete error: " + e.message);
    }
}

// --- Slider Logic ---
let i = 0, intv;
function startAutoSlide() {
    clearInterval(intv);
    if (images.length < 2) return;
    intv = setInterval(() => {
        i = (i + 1) % images.length;
        document.getElementById("slides").style.transform = `translateX(-${i * 100}vw)`;
    }, 4000);
}

// --- Admin Access (5 Clicks) ---
let clickCount = 0, timer;
document.getElementById("title").onclick = () => {
    clickCount++;
    clearTimeout(timer);
    if (clickCount === 5) { document.getElementById("admin").style.display = "block"; clickCount = 0; }
    timer = setTimeout(() => clickCount = 0, 1500);
};

function closeAdmin() { document.getElementById("admin").style.display = "none"; }

// --- Admin Access (5 Clicks + Password) ---
let clickCount = 0, timer;
const ADMIN_PASSWORD = "1234"; // <--- CHANGE YOUR PASSWORD HERE

document.getElementById("title").onclick = () => {
    clickCount++;
    clearTimeout(timer);
    
    if (clickCount === 5) {
        clickCount = 0; // Reset count
        
        // Ask for password
        let pw = prompt("Enter Admin Password:");
        
        if (pw === ADMIN_PASSWORD) {
            document.getElementById("admin").style.display = "block";
        } else if (pw !== null) {
            alert("Wrong password!");
        }
    }
    
    // Reset if clicks are too slow (more than 1.5 seconds apart)
    timer = setTimeout(() => clickCount = 0, 1500);
};

function closeAdmin() { 
    document.getElementById("admin").style.display = "none"; 
}
</script>
</body>
</html>
