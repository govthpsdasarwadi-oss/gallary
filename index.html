<!DOCTYPE html>
<html lang="kn">
<head>
<meta charset="UTF-8">
<title>Dasarwadi School Gallery (Auto Sync)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<style>
body {
  margin: 0;
  font-family: 'Segoe UI', Arial, sans-serif;
  background: #000;
  color: white;
  overflow: hidden;
  user-select: none;
}

/* Disable image drag */
img {
  pointer-events: none;
}

/* Header */
header {
  padding: 20px 10px;
  text-align: center;
  font-weight: bold;
  font-size: 36px;
  cursor: pointer;
  border-bottom: 2px solid #3498db;
  background: #0a3d62;
  overflow: hidden;
  white-space: nowrap;
}

.rainbow-text {
  display: inline-block;
  max-width: 100%;
  font-size: 36px;
  background: linear-gradient(270deg,
    #ff0000, #ff7300, #ffeb00, #47ff00,
    #00ffd5, #002bff, #7a00ff, #ff00c8, #ff0000);
  background-size: 1600% 1600%;
  animation: rainbowFlow 10s linear infinite;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

@keyframes rainbowFlow {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

/* Slider */
.slider {
  width: 100vw;
  height: calc(100vh - 90px);
  position: relative;
  overflow: hidden;
}

.slides {
  display: flex;
  height: 100%;
  transition: transform 0.8s ease-in-out;
}

.slides img {
  width: 100vw;
  height: 100%;
  object-fit: contain;
  background: #000;
  flex-shrink: 0;
}

/* Fullscreen button */
.full-btn {
  position: fixed;
  right: 12px;
  bottom: 12px;
  z-index: 999;
  background: #27ae60;
  border: none;
  color: white;
  padding: 10px 14px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
}

/* Admin Panel */
#admin {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: #f4f7f6;
  color: #333;
  z-index: 1000;
  padding: 15px;
  box-sizing: border-box;
  overflow-y: auto;
}

.admin-card {
  background: white;
  padding: 20px;
  border-radius: 20px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.2);
}

.upload-box {
  background: #eef2f3;
  padding: 15px;
  border-radius: 12px;
  margin-bottom: 20px;
  border: 2px dashed #0a3d62;
}

.upload-row {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.upload-row input {
  flex: 1;
}

button {
  width: 100%;
  padding: 14px;
  margin: 8px 0;
  border-radius: 10px;
  border: none;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
}

.save-btn { background: #0a3d62; color: white; }
.multi-btn { background: #16a085; color: white; }
.zip-btn { background: #8e44ad; color: white; }
.close-btn { background: #95a5a6; color: white; }

#thumbs {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  margin-top: 10px;
}

.thumb-wrapper {
  position: relative;
  border-radius: 8px;
  overflow: hidden;
  background: #ddd;
  border: 1px solid #ccc;
}

.thumb-wrapper.dragging {
  opacity: 0.5;
}

img.thumb {
  width: 100%;
  aspect-ratio: 4/3;
  object-fit: cover;
  display: block;
}

.btn-group {
  display: flex;
  gap: 2px;
  position: absolute;
  bottom: 0;
  width: 100%;
}

.btn-group button {
  margin: 0;
  border-radius: 0;
  font-size: 11px;
  padding: 8px 2px;
  flex: 1;
}

.del-btn { background: #e74c3c; color: white; }
</style>
</head>

<body oncontextmenu="return false">

<header id="title">
  <span class="rainbow-text">ಸರಕಾರಿ ಹಿರಿಯ ಪ್ರಾಥಮಿಕ ಶಾಲೆ ದಾಸರವಾಡಿ Gallery</span>
</header>

<div class="slider">
  <div class="slides" id="slides"></div>
</div>

<button class="full-btn" id="fullBtn" onclick="toggleFullscreen()">⛶ Full Screen</button>

<div id="admin">
  <div class="admin-card">
    <h3>Admin Panel</h3>

    <div class="upload-box">
      <div class="upload-row">
        <input type="file" id="singleFile" accept="image/*">
        <button class="save-btn" onclick="uploadSingle()">Upload Single</button>
      </div>
      <div class="upload-row">
        <input type="file" id="multiFile" accept="image/*" multiple>
        <button class="multi-btn" onclick="uploadMultiple()">Upload Multiple</button>
      </div>
      <div class="upload-row">
        <input type="file" id="zipFile" accept=".zip">
        <button class="zip-btn" onclick="uploadZip()">Upload ZIP</button>
      </div>
    </div>

    <div style="display:flex; justify-content:space-between; font-weight:bold; margin-top:10px;">
      <span>Manage Photos (Drag to Rearrange)</span>
      <span id="imgCount">0 Photos</span>
    </div>

    <div id="thumbs"></div>
    <button class="close-btn" onclick="closeAdmin()">Close Panel</button>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- JSZip -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBb4fvEag4UaBiiIClR2KJLo6XFyyQlAHU",
  authDomain: "my-school-7ed03.firebaseapp.com",
  databaseURL: "https://my-school-7ed03-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "my-school-7ed03",
  storageBucket: "my-school-7ed03.firebasestorage.app",
  messagingSenderId: "958140511497",
  appId: "1:958140511497:web:30e77b5310556025170fd8"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const imgRef = db.ref("gallery");

const slides = document.getElementById("slides");
const thumbs = document.getElementById("thumbs");
const fullBtn = document.getElementById("fullBtn");
let images = [];

// Auto-sync
imgRef.on("value", snap => {
  images = snap.val() || [];
  load();
});

function load() {
  slides.innerHTML = images.length === 0
    ? "<div style='width:100vw; height:100%; display:flex; align-items:center; justify-content:center;'>Empty</div>"
    : images.map(src => `<img src="${src}">`).join('');

  thumbs.innerHTML = images.map((src, idx) => `
    <div class="thumb-wrapper" draggable="true" data-index="${idx}">
      <img class="thumb" src="${src}">
      <div class="btn-group">
        <button class="save-btn" onclick="downloadSingle(${idx})">SAVE</button>
        <button class="del-btn" onclick="deleteImg(${idx})">DEL</button>
      </div>
    </div>
  `).join('');

  document.getElementById("imgCount").innerText = `${images.length} Photos`;
  enableDrag();
  startAutoSlide();
}

/* Upload single image */
function uploadSingle() {
  const file = document.getElementById("singleFile").files[0];
  if (!file) return alert("Select an image first");

  processImage(file, () => {
    imgRef.set(images);
    document.getElementById("singleFile").value = "";
  });
}

/* Upload multiple images */
function uploadMultiple() {
  const files = document.getElementById("multiFile").files;
  if (!files.length) return alert("Select images first");

  let index = 0;
  function next() {
    if (index >= files.length) {
      imgRef.set(images);
      document.getElementById("multiFile").value = "";
      return;
    }
    processImage(files[index++], next);
  }
  next();
}

/* Upload ZIP file */
async function uploadZip() {
  const zipInput = document.getElementById("zipFile");
  const file = zipInput.files[0];
  if (!file) return alert("Select a ZIP file first");

  const zip = await JSZip.loadAsync(file);
  const entries = Object.values(zip.files).filter(f =>
    !f.dir && /\.(jpg|jpeg|png|webp)$/i.test(f.name)
  );

  if (!entries.length) return alert("No images found in ZIP file.");

  let index = 0;
  async function next() {
    if (index >= entries.length) {
      imgRef.set(images);
      zipInput.value = "";
      return;
    }
    const blob = await entries[index++].async("blob");
    processImage(blob, next);
  }
  next();
}

/* Image processing (high quality) */
function processImage(file, callback) {
  const reader = new FileReader();
  reader.onload = e => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement("canvas");
      const max_w = 1600;
      const scale = Math.min(1, max_w / img.width);
      canvas.width = img.width * scale;
      canvas.height = img.height * scale;
      canvas.getContext("2d").drawImage(img, 0, 0, canvas.width, canvas.height);
      images.push(canvas.toDataURL("image/jpeg", 0.95));
      callback();
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

function deleteImg(idx) {
  if(confirm("Delete photo?")) {
    images.splice(idx, 1);
    imgRef.set(images);
  }
}

function downloadSingle(idx) {
  const link = document.createElement("a");
  link.href = images[idx];
  link.download = `school_photo_${idx + 1}.jpg`;
  link.click();
}

/* Auto slideshow */
let i = 0, intv;
function startAutoSlide() {
  clearInterval(intv);
  if (images.length < 2) return;
  intv = setInterval(() => {
    i = (i + 1) % images.length;
    slides.style.transform = `translateX(-${i * 100}vw)`;
  }, 4000);
}

/* Admin lock */
let clickCount = 0, timer;
document.getElementById("title").onclick = () => {
  clickCount++;
  clearTimeout(timer);
  if (clickCount === 5) {
    const pwd = prompt("Enter admin password:");
    if (pwd === "1234") {
      document.getElementById("admin").style.display = "block";
    } else {
      alert("Wrong password!");
    }
    clickCount = 0;
  }
  timer = setTimeout(() => clickCount = 0, 1500);
};

function closeAdmin() {
  document.getElementById("admin").style.display = "none";
}

/* Fullscreen toggle */
function toggleFullscreen() {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen();
    fullBtn.style.display = "none";
  } else {
    document.exitFullscreen();
    fullBtn.style.display = "block";
  }
}

/* Drag & Drop Rearranging */
let dragSrcIndex = null;
function enableDrag() {
  const items = document.querySelectorAll(".thumb-wrapper");
  items.forEach(item => {
    item.addEventListener("dragstart", e => {
      dragSrcIndex = Number(item.dataset.index);
      item.classList.add("dragging");
    });

    item.addEventListener("dragend", e => {
      item.classList.remove("dragging");
    });

    item.addEventListener("dragover", e => e.preventDefault());

    item.addEventListener("drop", e => {
      e.preventDefault();
      const targetIndex = Number(item.dataset.index);
      if (dragSrcIndex === null || dragSrcIndex === targetIndex) return;
      const moved = images.splice(dragSrcIndex, 1)[0];
      images.splice(targetIndex, 0, moved);
      imgRef.set(images);
      dragSrcIndex = null;
    });
  });
}
</script>
</body>
</html>
